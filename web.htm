<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <title>MA Client</title>
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
	<script src="http://libs.baidu.com/jquery/2.0.3/jquery.min.js"></script>
  <script src="http://imgcache.qq.com/bossweb/unikf/js/md5.js"></script>
    <meta name="description" content="MA Client">
    <meta name="author" content="binux">
  </head>

  <body>
<img src="http://mengsky.net/ol.png"/>
<h1>MA Bot(v0.6偽) 根本认不出来版 服务器当前负载:[connected]/[maxconnected]</h1>
MAClient backend version = [version_str]

<br>
最后重启时间[startup_time] <button onclick="toggle_hist()">更新历史↓</button><button style="font-weight:bold;color:#DF5823" onclick="showreCaptcha()">上传配置</button>
<br><div id=hehe style="display:none">
堵了两个漏洞
<br>
后台逻辑支持热替换
<br>
修改  修改后台日志.重启服务器
<br>
修改  版本跟进到5a4ae5d1c8
<br>
修改  错误的离线时间(多X了个3600
<br>
修改  修正一个可能会导致频繁被挤下线的逻辑问题
<br>
修改  报错修正
<br>
修改  自动添怪(之前会重复添)，BC>95% or AP>90% or (AP>7 and 自己没怪)上楼，自动买卡(1，2，3星小于5级卡)，自动领卡
<br>
修改  自己的 (BC>70 or BC>95%) 别人的 (BC>90%) 大刀(自动选3卡) 否则添
<br>
修改  打怪优先级 自己的>别人的小于10分钟的>没打过的>别人的小于20分钟的
<br>
修改  被挤掉重进时间3分改为8分钟（防止下不来2333333）
<br></div>
<div id=hehe style="display:none"><br>
  合并日服支持分支，能不能用我不知道的3
  <br>
  修正cn2区，cn3支持</div>
  退出离线模式:刷新本页,不勾选offline登陆,关闭浏览器
  <br>

    <section id=login>
      <form id=login_form onsubmit="return login(this);">
        login_id: <input id=login_id name=id />
        password: <input id=login_pwd type=password name=pwd />
        server: <select id=serv name=serv>
          <option selected>server</option>
          <option value="cn">国服一区</option>
          <option value="cn2">国服二区</option>
          <option value="cn3">国服三区</option>
          <option value="tw">台服</option>
          <option value="kr">韩服</option>
          <option value="jp">日服</option>
		  <option value="sg">海服</option>
        yourself http proxy for sd:
        </select>
        <input type=checkbox name=offline /> 离线挂机
        <input id=submit type=submit value=login />
	离线保持时间(小时): <input name="keep_time" value="12" />
      </form>
    </section>
    
	  <nobr><form id=upload_form onsubmit="return false;" style="display:none" enctype="multipart/form-data">
  	  <div class="recaptcha" id="recaptcha">别急，这里会有验证码</div>↑看不懂的那个乱输就可以了ww&nbsp;&nbsp;
      <input type="file" name="file" />
      <button onclick="submit_cfg()">上传</button>请先用GUI工具转换为<b>UTF-8编码</b>，配置文件中请<b>不要</b>保存账号密码
    </form></nobr>
    
    

<textarea id='log' name='log' readonly='readonly' style='border:1px solid #CCC;margin:0px;padding:0px;width:100%;height:500px;max-width:1300px;margin:auto'></textarea>

  </body>

  <script>
	function toggle_hist(){
		$("#hehe").each(function(){this.style.display = (this.style.display=='block')?'none':'block';});
		return false;
	};

    function log( text ) {
        $log = $('#log');
        //Add text to log
        $log.append(($log.val()?"":'')+text);
        //Autoscroll
        $log[0].scrollTop = $log[0].scrollHeight - $log[0].clientHeight;
    }

    if (window.WebSocket === undefined) {
      submit.disabled = true;
      login_form.id.disabled = true;
      login_form.pwd.disabled = true;
      log("WebSocket not supported. Using Chrome!\n");
    }


    function login(form) {
	
      if (window.ws) {
        ws.close();
      }
      var login_id = form.id.value,
          password = form.pwd.value,
          serv = form.serv.value,
          offline = form.offline.checked && "1" || "",
          keep_time = form.keep_time.value * 3600;
      ws = new WebSocket("ws://"+location.host+"/bot?id="+login_id+"&password="+password+"&serv="+serv+"&offline="+offline+"&keep_time="+keep_time);
      ws.onopen = function() {
        log("connected.\n");
        submit.disabled = true;
        login_form.id.disabled = true;
        login_form.pwd.disabled = true;
      };
      ws.onclose = function() {
        log("disconnected.\n");
        setTimeout(function() { login(form); }, 60*1000);
        submit.disabled = false;
        login_form.id.disabled = false;
        login_form.pwd.disabled = false;
      };
      ws.onmessage = function(event) {
        if (event.data != ''){log(event.data);}
      };
      submit.disabled = true;
      login_form.id.disabled = true;
      login_form.pwd.disabled = true;
      return false;
    }
  </script>
  <script>//upload_cfg
  function validate_file(f){
      if(file==null) return false;
      name = file.name;
      size = file.size;
      type = file.type;
      if(file.size>16384){
        log('太大了塞不进去，最大16kb\n');
        return false;
      }
      return true;
  }
  $(document).ready(function () {
    $(':file').change(function(){
      var file = this.files[0];
      if(!validate_file(file)) $('#upload_form')[0].reset();
  });
  });
  function submit_cfg() {
    var f = $(':file')[0].files[0];
    if(f==null){
      log('没有选择文件\n');return false;
    }
    var form = new FormData();
    var serv = $('#serv')[0].value;
    var login_id = $('#login_id')[0].value;
    var login_pwd = $('#login_pwd')[0].value;
    var captcha_resp = $('#recaptcha_response_field')[0].value;
    if(login_id=='' || login_pwd =='' ||serv == 'server' || captcha_resp==''){
      log('请填写用户名，密码，服务器，验证码\n');return false;
    }
    var _hash = hex_md5(login_id + login_pwd + serv);
    form.append("_hash", _hash);
    form.append("recaptcha_challenge", $('#recaptcha_challenge_field')[0].value);
    form.append("recaptcha_response", captcha_resp);
    form.append("file", f);
    var xhr = new XMLHttpRequest();
    xhr.open("post", '/upload_cfg', true);
    xhr.onload = function () {
        console.log(xhr.responseText);
        switch(xhr.responseText){
          case '-1':log("验证码填错\n");break;
          case '-2':log("少填参数\n");break;
          case '-3':log("文件太大了(最大16kb\n");break;
          default:log("配置上传完成\n");
        }
    };
    xhr.send(form);
    return false;
  }
  </script>
  <script>//http://www.luokr.com/p/4
  function showreCaptcha() {
  $('#upload_form')[0].style.display='block';
	var r = document.createElement('script'); r.type = 'text/javascript'; r.async = true;
	r.src = "http://www.google.com/recaptcha/api/js/recaptcha_ajax.js";
	var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(r, s);

	var w = 0;
	var a = function(){
		console.log('Waiting for Google Recaptcha: ' + w + 'ms');
		if (window.Recaptcha)
		{
			Recaptcha.create('6Lfq-PISAAAAAOv4FMjuqMtx8tZbvrMr-VMjQ2GO', 'recaptcha', {
				theme: "white",
				callback: function(){
					$('iframe:hidden').hide();Recaptcha.focus_response_field();
					$('#recaptcha_response_field')[0].placeholder='输入两个单词／人◕‿‿◕人＼';
				}
			});
		}
		else if (w >= 1500)
		{
		}
		else
		{
			setTimeout(a, w += 500);
		}
	};a();
	}</script>
</html>
<!-- vim: set et sw=2 ts=2 sts=2 ff=unix fenc=utf8: -->
